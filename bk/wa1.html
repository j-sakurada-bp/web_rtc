<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <style type="text/css">
        input[type=button] {
            width: 100px;
            margin: 5px;
            height: 30px;
            font-size: 16px;
        }
        </style>
        <script type="text/javascript" src="js2/jquery-3.3.1.js"></script>
        <script type="text/javascript">

            var _bufSize = 4096;
            var _wholeBuffer= [];
            var _ctx = null;
            var _processor = null;
            var _ttsInput = null;

            // 初期化処理
            $(function() {
                setupEventHander();
                initProcessor();
            });

            /**
             * イベントリスナの設定
             */
            function setupEventHander() {
                $('#btnStart').on('click', startRecord);
                $('#btnStop').on('click', pauseRecord);
            }

            /**
             * 記録の開始
             */
            function startRecord(event) {
                _wholeBuffer = [];
                setupAudioProcessEventHandler(_processor);
                // _processor.connect(_ctx.destination);
            }

            /**
             * 記録の一時停止
             */
            function pauseRecord(event) {
                releaseAudioProcessEventHandler(_processor);
                _ttsInput.disconnect();
                console.log(_wholeBuffer.length);
                console.log(_wholeBuffer);
            }

            /**
             * 記録の終了
             */
            function endRecord(event) {
                releaseAudioProcessEventHandler(_processor);
                _ttsInput.disconnect();
                console.log(_wholeBuffer.length);
                console.log(_wholeBuffer);
            }

            /**
             * プロセッサを初期化する。
             */
            function initProcessor() {
                navigator.mediaDevices.getUserMedia({ audio : true })
                    .then(onSuccess)
                    .catch(onError);
            }

            /**
             * 音声メディアストリーム出力を記録プロセッサの入力に設定する。
             * 音声メディアの使用許可がされた時に実行されるコールバック関数。
             */
            var onSuccess = stream => {

                _ctx = getContext();

                _ttsInput = _ctx.createMediaStreamSource(stream);
                var mixerOutput = _ctx.createMediaStreamDestination();
                _processor = _ctx.createScriptProcessor();
                _ttsInput.connect(_processor);
                // setupAudioProcessEventHandler(_processor);
                // _processor.connect(_ctx.destination);
            }

            /**
             * エラーハンドラ。
             * 音声メディア使用を拒否した場合や、その他エラーが発生した場合に実行される。
             */
            var onError = error => {
                console.log('ERROR : ' + error);
                alert('ERROR raised. : ' + error);
            }

            /**
             * ScriptProcessorにaudioprocessイベントハンドラを設定する。
             */
            function setupAudioProcessEventHandler(prcsr) {
                prcsr.onaudioprocess = function(event) {
                    var channel = event.inputBuffer.getChannelData(0);
                    var buffer = new Float32Array(_bufSize);
                    for (var i = 0; i < _bufSize; i++) {
                        buffer[i] = channel[i];
                    }
                    _wholeBuffer.push(buffer);
                };
            }

            /**
             * ScriptProcessorからaudioprocessイベントハンドラを解除する。
             */
            function releaseAudioProcessEventHandler(prcsr) {
                prcsr.onaudioprocess = null;
            }

            /**
             * audioメディア取得用contextを取得する。
             */
            function getContext() {
                var context = window.AudioContext || window.webkitAudioContext;
                return new context();
            };

            /**
             * RTCPeerConnectionを取得する。
             */
            function getRTCPeerConnection() {
                var PC =
                    window.RTCPeerConnection
                    || window.webkitRTCPeerConnection
                    || window.mozRTCPeerConnection;
                return new PC();
            }

        </script>
    </head>
    <body>
        <!-- <audio id="ttsRecorder" autoplay="false" controls></audio><br/> -->
        <input id="btnStart" type="button" value="開始" />
        <input id="btnStop" type="button" value="終了" />
    </body>
</html>
