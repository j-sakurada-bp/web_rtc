<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <style type="text/css">
        input[type=text] {
            width: 200px;
            height: 20px;
            margin-bottom: 5px;
            font-size: 16px;
        }
        .lblTitle {
            display: inline-block;
            width: 100px;
            height: 20px;
            font-size: 14px;
            margin-bottom: 5px;
            padding-right: 7px;
            text-align: right;
        }
        #showStatus {
            margin: 5px 5px 5px 5px;
            font-size: 14px;
            color: red;
            font-style: italic;
        }
        .msg-area {
            display: inline-block;
        }
        .ios {
            color: blue;
        }
        .server {
            color: red;
        }
        input[type=button] {
            width: 150px;
            margin: 5px;
            height: 30px;
            font-size: 16px;
        }
        #btnEnablePlayer {
            width: 250px;
        }
        </style>
        <script type="text/javascript" src="js2/jquery-3.3.1.js"></script>
        <script type="text/javascript" src="js/sora.js"></script>
        <script type="text/javascript" src="js2/tts_test.js?v=1"></script>

        <script type="text/javascript">
            // 定数
            const IP_ADDRESS = '13.231.213.196';
            const SUB_DOMAIN = 'resources/wav';
            const FILENAME = 'eine.mp3';
            const MEDIA_TYPE = 'audio/wave';
            // グローバル変数
            let _publisher = null;
            let _player = null;
            let _playerDisabled = true;

            /**
             * 初期化処理
             */
            $(function() {
                _player = document.getElementById('audioPlayer');
                setupEventHander();
            });

            /**
             * イベントリスナの設定
             */
            function setupEventHander() {
                $('#btnConnIOS').on('click', connectToClient);
                $('#btnDisconnIOS').on('click', disconnectFromClient);
                $('#btnConnServer').on('click', connectToTTSServer);
                $('#btnDisconnServer').on('click', disconnectFromTTSServer);
                $('#btnEnablePlayer').on('click', enablePlayer);
                // 画面項目制御
                controlEnable('init');
            }

            /**
             * 「iOSと接続」ボタンイベントリスナ。
             */
            function connectToClient() {

                let channelId = $('#txtChannelId').val();
                let metadata = $('#txtChannelId').val();
                if (validate(channelId, metadata) === false) {
                    return;
                }

                // iOSクライアントとの間に下り専用のWebRTCコネクションを設立する
                _publisher = getSoraPublisher(channelId, metadata);
                // 画面項目制御
                controlEnable('btnConnIOS');
            }

            /**
             * 入力チェック
             */
            let validate = function(channelId, metadata) {
                if (!channelId) {
                    alert('チャネルIdを入力して下さい。');
                    return false;
                }
                return true;
            }

            /**
             * 「iOSから切断」ボタンイベントリスナ。
             */
            function disconnectFromClient() {
                // 画面項目制御
                controlEnable('btnDisconnIOS');
                // oWebRTCコネクションを切断する
                _publisher = null;
            }

            /**
             * 「サーバと接続」ボタンイベントリスナ。
             */
            function connectToTTSServer() {
                // WebRTCのConnectionに接続する
                connectStream();
                // 画面項目制御
                controlEnable('btnConnServer');
            }

            /**
             * 「サーバから切断」ボタンイベントリスナ。
             */
            function disconnectFromTTSServer() {
                _player.pause();
                _publisher.disconnect();
                // 画面項目制御
                controlEnable('btnDisconnServer');
            }

            /**
             * オーディオプレイヤーの使用可否を制御する。
             */
            function enablePlayer() {

                _playerDisabled = !_playerDisabled;

                const player = $('#audioPlayer');
                player.prop('disabled', _playerDisabled);

                let caption = null;
                if (_playerDisabled) {
                    player.hide();
                    caption = 'プレイヤー表示 / ミュート解除';
                } else {
                    player.show();
                    caption = 'プレイヤー非表示 / ミュート';
                }
                $('#btnEnablePlayer').val(caption);
                _player.muted = _playerDisabled;
            }

            /**
             * プレイヤーに入力音声のソースを設定する。
             */
            function setupAudioMedia() {
                const url =
                    'http://adrs/sd/fname'
                        .replace('adrs', IP_ADDRESS)
                        .replace('sd', SUB_DOMAIN)
                        .replace('fname', FILENAME);
                _player.src = url;
            }

            /**
             *
             */
            function connectStream() {
                // ブラウザ上のメディアプレイヤーを取得し、そのstreamをwebRTCのstreamへ接続する
                getUserMedia({ audio : true })
                    .then(onSuccess)
                    .catch(onError);
            }

            /**
             * メディアプレイヤーの出力を、webRTCへの出力へ接続する
             */
            var onSuccess = stream => {

                console.log(stream);
                // サーバ上の音源を割り当てる
                setupAudioMedia();
                //
                let ctx = getContext();
                console.log(ctx);

                let url = _player.src;
                console.log(url);

                let myAudio = new Audio(url);
                console.log(myAudio);
                let src = ctx.createMediaElementSource(_player);
                console.log(src);

                console.log(ctx.createMediaStreamDestination().stream);

                _publisher.connect(stream);
                // 音源の再生を開始する
                playAudio();
            }

            /**
             * エラー発生時のハンドラ。
             */
            var onError = error => {
                console.log('ERROR : ' + error);
                alert('ERROR raised. : ' + error);
            }

            /**
             * オーディオプレイヤーをplayする。
             */
            function playAudio() {
                _player.muted = true;
                _player.play();
            }


            /**
             * ボタンの使用可否を制御する
             */
            function controlEnable(target) {
                const msg1 = 'クライアントと接続中。(SORAのPublisherを生成)';
                const msg2 = 'サーバと接続、音源再生中。。(TTSのダミー。サーバの/resources/wav/001.mp3です)';
                let flags = [];
                let txts = [];
                if (target === 'init') {
                    flags = [false, true, true, true];
                    txts = ['', ''];
                    $('#txtChannelId').val('tcdt');
                } else if (target === 'btnConnIOS') {
                    flags = [true, false, false, true];
                    txts = [msg1, ''];
                } else if (target === 'btnDisconnIOS') {
                    flags = [false, true, true, true];
                    txts = ['', ''];
                } else if (target === 'btnConnServer') {
                    flags = [true, true, true, false];
                    txts = [msg1, msg2];
                } else if (target === 'btnDisconnServer') {
                    flags = [true, false, false, true];
                    txts = [msg1, ''];
                }
                $('#btnConnIOS').prop('disabled', flags[0]);
                $('#btnDisconnIOS').prop('disabled', flags[1]);
                $('#btnConnServer').prop('disabled', flags[2]);
                $('#btnDisconnServer').prop('disabled', flags[3]);

                $('.ios').text(txts[0]);
                $('.server').text(txts[1]);
            }

        </script>
    </head>
    <body>
        <div class="lblTitle">チャネルId</div><input id="txtChannelId" type="text" /><br/>
        <div class="lblTitle">メタデータ</div><input id="txtMetadata" type="text" /><br/>
        <!-- <div id="showStatus">SORAの接続パラメータ「channelId」「metadata」は、それぞれURLの「cid」「md」に指定します。</div> -->
        <input id="btnConnIOS" type="button" value="iOSと接続" />
        <input id="btnDisconnIOS" type="button" value="iOSから切断"/>
        <div class="msg-area ios"></div>
        <br/>
        <input id="btnConnServer" type="button" value="サーバと接続"/>
        <input id="btnDisconnServer" type="button" value="サーバから切断"/>
        <div class="msg-area server"></div>
        <br/>
        <input id="btnEnablePlayer" type="button" value="プレイヤー表示 / ミュート解除" />
        <br/>
        <audio id="audioPlayer" style="display: none;" loop controls>
        </audio>
    </body>
</html>
